--liquibase formatted sql
--changeset esasdelli:GDM_VIEW_SEG_REGG_DA_CONSERVARE runOnChange:true stripComments:false

  CREATE OR REPLACE FORCE VIEW "SEG_REGG_DA_CONSERVARE" ("ID_DOCUMENTO", "ID_ATTIVITA", "ID_NODO", "ID_ITER", "ESPRESSIONE", "DESCRIZIONE", "URL_RIF", "URL_RIF_DESC", "URL_EXEC", "URL_EXEC_DESC", "SYNC_EXECTYPE", "SYNC_EXECTYPE_DESCR", "TIPO", "SCADENZA", "SCADENZA_STRINGA", "VARIABILEDIRITORNO", "SITUAZIONE_SCADENZA", "PARAM_INIT_ITER", "NOME_ITER", "DESCRIZIONE_ITER", "ACL_CONTROL_ASSIGN", "ACL_CONTROL_TYPE_ASSIGNED", "TIPO_OGGETTO", "OGGETTO", "ATTIVITA_HELP", "ATTIVITA_DESCR", "MESSAGGIO_TODO", "COLORE", "ORDINAMENTO", "DATA_ATTIVAZIONE", "PRESA_IN_CARICO", "ASSEGNA_A", "ESEGUI", "RIMUOVI_IN_CARICO", "UP_DESCRIZIONE", "ATTIVAZIONE") AS 
  SELECT DISTINCT            QUER.id_query ID_DOCUMENTO,            '' id_attivita,            '' id_nodo,            '' id_iter,            '' espressione,            DECODE (LOCO1.STATO_CONSERVAZIONE,                    'FC', 'Fallita conservazione di ',                    '')            || COUNT (1)            || DECODE (COUNT (1),                       1, ' Registro mandato ',                       ' Registri mandati ')            || ' in conservazione con la Transazione '            || loco1.id_transazione            || DECODE (loco1.data_inizio,                       NULL, '',                       ' del ' || TO_CHAR (loco1.data_inizio, 'dd/mm/yyyy'))            || DECODE (LOCO1.STATO_CONSERVAZIONE,                       'DC', ' ancora in stato ''da conservare'' ',                       'IC', ' ancora in stato ''in conservazione'' ',                       '')               descrizione,            '' url_rif,            '' url_rif_desc,               '/jdms/common/WorkArea.do?WRKSP='            || (-CART.id_cartella)            || CHR (38)            || 'idQuery='            || QUER.id_query               url_exec,            'Registri mandati in conservazione con la Transazione '            || loco1.id_transazione               url_exec_desc,            'DOCUMENTO_GDM' sync_exectype,            'Documento di GDM' sync_exectype_descr,            '16' tipo,            '' scadenza,            '' scadenza_stringa,            '' variabilediritorno,            '' situazione_scadenza,            '' param_init_iter,            '' nome_iter,            '' descrizione_iter,            '' acl_control_assign,            '' acl_control_type_assigned,            '' tipo_oggetto,            '' oggetto,            'Registri mandati ' || ' in conservazione da controllare '               attivita_help,            '' attivita_descr,            '' messaggio_todo,            '' colore,            '' ordinamento,            loco1.data_inizio data_attivazione,            '0' presa_in_carico,            '0' assegna_a,            '1' esegui,            '0' rimuovi_in_carico,            '' up_descrizione,            '' attivazione       FROM DOCUMENTI DOCU,            DOCUMENTI DOCU_LOCO1,            SPR_REGISTRO_GIORNALIERO REGG,            GDM_T_LOG_CONSERVAZIONE LOCO1,            query QUER,            cartelle CART,            links link      WHERE     REGG.ID_DOCUMENTO = DOCU.ID_DOCUMENTO            AND CART.id_cartella = LINK.ID_CARTELLA            AND QUER.codiceads = 'LOG_CON'            AND QUER.ID_QUERY = LINK.ID_OGGETTO            AND LINK.TIPO_OGGETTO = 'Q'            AND REGG.STATO_PR = 'PR'            AND regg.data < TRUNC (SYSDATE)            AND DOCU.stato_documento NOT IN ('CA', 'RE', 'PB')            AND loco1.id_documento = docu_loco1.id_documento            AND docu_loco1.stato_documento NOT IN ('CA', 'RE', 'PB')            AND loco1.id_documento_riF = docu.id_documento            AND loco1.stato_conservazione IN ('DC', 'IC', 'FC')            AND NVL (LOCO1.DATA_INIZIO, regg.data) < TRUNC (SYSDATE)            AND (SELECT COUNT (1)                   FROM GDM_T_LOG_CONSERVAZIONE LOCO, documenti docu_loco                  WHERE     LOCO.ID_DOCUMENTO_RIF = DOCU.ID_DOCUMENTO                        AND docu_loco.id_documento = loco.id_documento                        AND docu_loco.stato_documento NOT IN ('CA', 'RE', 'PB')                        AND STATO_CONSERVAZIONE = 'CC' ) = 0     HAVING COUNT (1) > 0   GROUP BY loco1.id_transazione,            loco1.data_inizio,            LOCO1.STATO_CONSERVAZIONE,            CART.id_cartella,            quer.id_query
/
