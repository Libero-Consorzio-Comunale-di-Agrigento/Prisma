--liquibase formatted sql
--changeset esasdelli:GDM_TRIGGER_AG_SPR_LETTERE_USCITA_AU runOnChange:true stripComments:false
CREATE OR REPLACE  TRIGGER ag_SPR_LETTERE_USCITA_au  AFTER UPDATE ON SPR_LETTERE_USCITA REFERENCING NEW AS New OLD AS Old  FOR EACH ROW  BEGIN    IF NVL (:OLD.stato_pr, 'DP') != NVL (:NEW.stato_pr, 'DP') AND NVL (:NEW.stato_pr, 'DP') = 'PR' THEN       AG_MEMO_UTILITY.SET_STATO_FROM_PROT(:NEW.id_documento, 'PR');       DECLARE       a_messaggio    VARCHAR2 (32000);       a_istruzione   VARCHAR2 (32000);       BEGIN       a_messaggio :=       'Fallita notifica di inserimento in fascicolo del protocollo identificato da '      || :NEW.id_documento;       a_istruzione :=       'begin ag_documento_utility.notifica_ins_fasc ('      || :NEW.id_documento       || '); end ;';      integritypackage.set_postevent (a_istruzione, a_messaggio);      END;    END IF;    IF nvl(:NEW.OGGETTO,'') <> nvl(:OLD.OGGETTO,'') THEN       AG_UTILITIES_CRUSCOTTO.UPD_OGG_TASK_EST_COMMIT (:NEW.IDRIF,nvl(:NEW.OGGETTO,''),nvl(:OLD.OGGETTO,''),:NEW.ANNO,:NEW.NUMERO);   END IF;   EXCEPTION WHEN OTHERS THEN      RAISE_APPLICATION_ERROR(-20999,'Errore in aggiornamento oggetto dei task esterni. Errore: '||sqlerrm); END;
/
