--liquibase formatted sql
--changeset esasdelli:GDM_PROCEDURE_AGG_SEG_AMM_AOO_UO runOnChange:true stripComments:false

CREATE OR REPLACE PROCEDURE AGG_SEG_AMM_AOO_UO
IS
   conta   NUMBER := 0;
   PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
   FOR nuovi
      IN (SELECT AL,
                 AMMIN,
                 ANAGRAFICA,
                 AOO,
                 C_FISCALE_IMPRESA,
                 C_VIA_IMPRESA,
                 CAP_AMM,
                 CAP_AOO,
                 CAP_BENEFICIARIO,
                 CAP_DOM,
                 CAP_IMPRESA,
                 CAP_PER_SEGNATURA,
                 CAP_RES,
                 CAP_UO,
                 CF,
                 CF_BENEFICIARIO,
                 CF_NULLABLE,
                 CF_PER_SEGNATURA,
                 COD_AMM,
                 COD_AMM_ORIGINALE,
                 COD_AOO,
                 COD_AOO_ORIGINALE,
                 COD_UO,
                 COD_UO_ORIGINALE,
                 CODICE_FISCALE,
                 COGNOME,
                 COGNOME_PER_SEGNATURA,
                 COMUNE,
                 COMUNE_AMM,
                 COMUNE_AOO,
                 COMUNE_BENEFICIARIO,
                 COMUNE_DOM,
                 COMUNE_IMPRESA,
                 COMUNE_NASCITA,
                 COMUNE_PER_SEGNATURA,
                 COMUNE_RES,
                 COMUNE_UO,
                 DAL,
                 DAL_AMM,
                 DAL_PERSONA,
                 DATA_NASCITA,
                 DATA_NASCITA_BENEFICIARIO,
                 DATI_AMM,
                 DATI_AOO,
                 DATI_UO,
                 DENOMINAZIONE,
                 DENOMINAZIONE_BENEFICIARIO,
                 DENOMINAZIONE_PER_SEGNATURA,
                 DENOMINAZIONE_SEDE,
                 DESCRIZIONE_AMM,
                 DESCRIZIONE_AOO,
                 DESCRIZIONE_UO,
                 EMAIL,
                 FAX,
                 FAX_AMM,
                 FAX_AOO,
                 FAX_BENEFICIARIO,
                 FAX_DOM,
                 FAX_RES,
                 FAX_UO,
                 IMPRESA,
                 INDIRIZZO,
                 INDIRIZZO_AMM,
                 INDIRIZZO_AOO,
                 INDIRIZZO_BENEFICIARIO,
                 INDIRIZZO_DOM,
                 INDIRIZZO_PER_SEGNATURA,
                 INDIRIZZO_RES,
                 INDIRIZZO_UO,
                 INSEGNA,
                 MAIL_AMM,
                 MAIL_AOO,
                 MAIL_BENEFICIARIO,
                 MAIL_IMPRESA,
                 MAIL_PERSONA,
                 MAIL_UO,
                 MAILFAX,
                 N_CIVICO_IMPRESA,
                 NATURA_GIURIDICA,
                 NI,
                 NI_AMM,
                 NI_GSD,
                 NI_IMPRESA,
                 NI_PERSONA,
                 NOME,
                 NOME_PER_SEGNATURA,
                 PARTITA_IVA,
                 PARTITA_IVA_IMPRESA,
                 PI,
                 PI_BENEFICIARIO,
                 PROVINCIA_BENEFICIARIO,
                 PROVINCIA_DOM,
                 PROVINCIA_PER_SEGNATURA,
                 PROVINCIA_RES,
                 SESSO,
                 SIGLA_PROV_AMM,
                 SIGLA_PROV_AOO,
                 SIGLA_PROV_UO,
                 TEL_DOM,
                 TEL_RES,
                 TEL_UO,
                 TIPO,
                 TIPO_LOCALIZZAZIONE,
                 TIPO_SOGGETTO,
                 VIA_IMPRESA,
                 VIS_INDIRIZZO
            FROM SEG_AMM_AOO_UO
          MINUS
          SELECT AL,
                 AMMIN,
                 ANAGRAFICA,
                 AOO,
                 C_FISCALE_IMPRESA,
                 C_VIA_IMPRESA,
                 CAP_AMM,
                 CAP_AOO,
                 CAP_BENEFICIARIO,
                 CAP_DOM,
                 CAP_IMPRESA,
                 CAP_PER_SEGNATURA,
                 CAP_RES,
                 CAP_UO,
                 CF,
                 CF_BENEFICIARIO,
                 CF_NULLABLE,
                 CF_PER_SEGNATURA,
                 COD_AMM,
                 COD_AMM_ORIGINALE,
                 COD_AOO,
                 COD_AOO_ORIGINALE,
                 COD_UO,
                 COD_UO_ORIGINALE,
                 CODICE_FISCALE,
                 COGNOME,
                 COGNOME_PER_SEGNATURA,
                 COMUNE,
                 COMUNE_AMM,
                 COMUNE_AOO,
                 COMUNE_BENEFICIARIO,
                 COMUNE_DOM,
                 COMUNE_IMPRESA,
                 COMUNE_NASCITA,
                 COMUNE_PER_SEGNATURA,
                 COMUNE_RES,
                 COMUNE_UO,
                 DAL,
                 DAL_AMM,
                 DAL_PERSONA,
                 DATA_NASCITA,
                 DATA_NASCITA_BENEFICIARIO,
                 DATI_AMM,
                 DATI_AOO,
                 DATI_UO,
                 DENOMINAZIONE,
                 DENOMINAZIONE_BENEFICIARIO,
                 DENOMINAZIONE_PER_SEGNATURA,
                 DENOMINAZIONE_SEDE,
                 DESCRIZIONE_AMM,
                 DESCRIZIONE_AOO,
                 DESCRIZIONE_UO,
                 EMAIL,
                 FAX,
                 FAX_AMM,
                 FAX_AOO,
                 FAX_BENEFICIARIO,
                 FAX_DOM,
                 FAX_RES,
                 FAX_UO,
                 IMPRESA,
                 INDIRIZZO,
                 INDIRIZZO_AMM,
                 INDIRIZZO_AOO,
                 INDIRIZZO_BENEFICIARIO,
                 INDIRIZZO_DOM,
                 INDIRIZZO_PER_SEGNATURA,
                 INDIRIZZO_RES,
                 INDIRIZZO_UO,
                 INSEGNA,
                 MAIL_AMM,
                 MAIL_AOO,
                 MAIL_BENEFICIARIO,
                 MAIL_IMPRESA,
                 MAIL_PERSONA,
                 MAIL_UO,
                 MAILFAX,
                 N_CIVICO_IMPRESA,
                 NATURA_GIURIDICA,
                 NI,
                 NI_AMM,
                 NI_GSD,
                 NI_IMPRESA,
                 NI_PERSONA,
                 NOME,
                 NOME_PER_SEGNATURA,
                 PARTITA_IVA,
                 PARTITA_IVA_IMPRESA,
                 PI,
                 PI_BENEFICIARIO,
                 PROVINCIA_BENEFICIARIO,
                 PROVINCIA_DOM,
                 PROVINCIA_PER_SEGNATURA,
                 PROVINCIA_RES,
                 SESSO,
                 SIGLA_PROV_AMM,
                 SIGLA_PROV_AOO,
                 SIGLA_PROV_UO,
                 TEL_DOM,
                 TEL_RES,
                 TEL_UO,
                 TIPO,
                 TIPO_LOCALIZZAZIONE,
                 TIPO_SOGGETTO,
                 VIA_IMPRESA,
                 VIS_INDIRIZZO
            FROM SEG_AMM_AOO_UO_TAB)
   LOOP
      conta := conta + 1;

      DELETE SEG_AMM_AOO_UO_TAB
       WHERE     cod_amm = nuovi.cod_amm
             AND NVL (cod_aoo, ' ') = NVL (nuovi.cod_aoo, ' ')
             AND NVL (cod_uo, ' ') = NVL (nuovi.cod_uo, ' ')
             AND NVL (email, ' ') = NVL (nuovi.email, ' ');

      INSERT INTO SEG_AMM_AOO_UO_TAB (AL,
                                      AMMIN,
                                      ANAGRAFICA,
                                      AOO,
                                      C_FISCALE_IMPRESA,
                                      C_VIA_IMPRESA,
                                      CAP_AMM,
                                      CAP_AOO,
                                      CAP_BENEFICIARIO,
                                      CAP_DOM,
                                      CAP_IMPRESA,
                                      CAP_PER_SEGNATURA,
                                      CAP_RES,
                                      CAP_UO,
                                      CF,
                                      CF_BENEFICIARIO,
                                      CF_NULLABLE,
                                      CF_PER_SEGNATURA,
                                      COD_AMM,
                                      COD_AMM_ORIGINALE,
                                      COD_AOO,
                                      COD_AOO_ORIGINALE,
                                      COD_UO,
                                      COD_UO_ORIGINALE,
                                      CODICE_FISCALE,
                                      COGNOME,
                                      COGNOME_PER_SEGNATURA,
                                      COMUNE,
                                      COMUNE_AMM,
                                      COMUNE_AOO,
                                      COMUNE_BENEFICIARIO,
                                      COMUNE_DOM,
                                      COMUNE_IMPRESA,
                                      COMUNE_NASCITA,
                                      COMUNE_PER_SEGNATURA,
                                      COMUNE_RES,
                                      COMUNE_UO,
                                      DAL,
                                      DAL_AMM,
                                      DAL_PERSONA,
                                      DATA_NASCITA,
                                      DATA_NASCITA_BENEFICIARIO,
                                      DATI_AMM,
                                      DATI_AOO,
                                      DATI_UO,
                                      DENOMINAZIONE,
                                      DENOMINAZIONE_BENEFICIARIO,
                                      DENOMINAZIONE_PER_SEGNATURA,
                                      DENOMINAZIONE_SEDE,
                                      DESCRIZIONE_AMM,
                                      DESCRIZIONE_AOO,
                                      DESCRIZIONE_UO,
                                      EMAIL,
                                      FAX,
                                      FAX_AMM,
                                      FAX_AOO,
                                      FAX_BENEFICIARIO,
                                      FAX_DOM,
                                      FAX_RES,
                                      FAX_UO,
                                      IMPRESA,
                                      INDIRIZZO,
                                      INDIRIZZO_AMM,
                                      INDIRIZZO_AOO,
                                      INDIRIZZO_BENEFICIARIO,
                                      INDIRIZZO_DOM,
                                      INDIRIZZO_PER_SEGNATURA,
                                      INDIRIZZO_RES,
                                      INDIRIZZO_UO,
                                      INSEGNA,
                                      MAIL_AMM,
                                      MAIL_AOO,
                                      MAIL_BENEFICIARIO,
                                      MAIL_IMPRESA,
                                      MAIL_PERSONA,
                                      MAIL_UO,
                                      MAILFAX,
                                      N_CIVICO_IMPRESA,
                                      NATURA_GIURIDICA,
                                      NI,
                                      NI_AMM,
                                      NI_GSD,
                                      NI_IMPRESA,
                                      NI_PERSONA,
                                      NOME,
                                      NOME_PER_SEGNATURA,
                                      PARTITA_IVA,
                                      PARTITA_IVA_IMPRESA,
                                      PI,
                                      PI_BENEFICIARIO,
                                      PROVINCIA_BENEFICIARIO,
                                      PROVINCIA_DOM,
                                      PROVINCIA_PER_SEGNATURA,
                                      PROVINCIA_RES,
                                      SESSO,
                                      SIGLA_PROV_AMM,
                                      SIGLA_PROV_AOO,
                                      SIGLA_PROV_UO,
                                      TEL_DOM,
                                      TEL_RES,
                                      TEL_UO,
                                      TIPO,
                                      TIPO_LOCALIZZAZIONE,
                                      TIPO_SOGGETTO,
                                      VIA_IMPRESA,
                                      VIS_INDIRIZZO)
           VALUES (nuovi.AL,
                   nuovi.AMMIN,
                   nuovi.ANAGRAFICA,
                   nuovi.AOO,
                   nuovi.C_FISCALE_IMPRESA,
                   nuovi.C_VIA_IMPRESA,
                   nuovi.CAP_AMM,
                   nuovi.CAP_AOO,
                   nuovi.CAP_BENEFICIARIO,
                   nuovi.CAP_DOM,
                   nuovi.CAP_IMPRESA,
                   nuovi.CAP_PER_SEGNATURA,
                   nuovi.CAP_RES,
                   nuovi.CAP_UO,
                   nuovi.CF,
                   nuovi.CF_BENEFICIARIO,
                   nuovi.CF_NULLABLE,
                   nuovi.CF_PER_SEGNATURA,
                   nuovi.COD_AMM,
                   nuovi.COD_AMM_ORIGINALE,
                   nuovi.COD_AOO,
                   nuovi.COD_AOO_ORIGINALE,
                   nuovi.COD_UO,
                   nuovi.COD_UO_ORIGINALE,
                   nuovi.CODICE_FISCALE,
                   nuovi.COGNOME,
                   nuovi.COGNOME_PER_SEGNATURA,
                   nuovi.COMUNE,
                   nuovi.COMUNE_AMM,
                   nuovi.COMUNE_AOO,
                   nuovi.COMUNE_BENEFICIARIO,
                   nuovi.COMUNE_DOM,
                   nuovi.COMUNE_IMPRESA,
                   nuovi.COMUNE_NASCITA,
                   nuovi.COMUNE_PER_SEGNATURA,
                   nuovi.COMUNE_RES,
                   nuovi.COMUNE_UO,
                   nuovi.DAL,
                   nuovi.DAL_AMM,
                   nuovi.DAL_PERSONA,
                   nuovi.DATA_NASCITA,
                   nuovi.DATA_NASCITA_BENEFICIARIO,
                   nuovi.DATI_AMM,
                   nuovi.DATI_AOO,
                   nuovi.DATI_UO,
                   nuovi.DENOMINAZIONE,
                   nuovi.DENOMINAZIONE_BENEFICIARIO,
                   nuovi.DENOMINAZIONE_PER_SEGNATURA,
                   nuovi.DENOMINAZIONE_SEDE,
                   nuovi.DESCRIZIONE_AMM,
                   nuovi.DESCRIZIONE_AOO,
                   nuovi.DESCRIZIONE_UO,
                   nuovi.EMAIL,
                   nuovi.FAX,
                   nuovi.FAX_AMM,
                   nuovi.FAX_AOO,
                   nuovi.FAX_BENEFICIARIO,
                   nuovi.FAX_DOM,
                   nuovi.FAX_RES,
                   nuovi.FAX_UO,
                   nuovi.IMPRESA,
                   nuovi.INDIRIZZO,
                   nuovi.INDIRIZZO_AMM,
                   nuovi.INDIRIZZO_AOO,
                   nuovi.INDIRIZZO_BENEFICIARIO,
                   nuovi.INDIRIZZO_DOM,
                   nuovi.INDIRIZZO_PER_SEGNATURA,
                   nuovi.INDIRIZZO_RES,
                   nuovi.INDIRIZZO_UO,
                   nuovi.INSEGNA,
                   nuovi.MAIL_AMM,
                   nuovi.MAIL_AOO,
                   nuovi.MAIL_BENEFICIARIO,
                   nuovi.MAIL_IMPRESA,
                   nuovi.MAIL_PERSONA,
                   nuovi.MAIL_UO,
                   nuovi.MAILFAX,
                   nuovi.N_CIVICO_IMPRESA,
                   nuovi.NATURA_GIURIDICA,
                   nuovi.NI,
                   nuovi.NI_AMM,
                   nuovi.NI_GSD,
                   nuovi.NI_IMPRESA,
                   nuovi.NI_PERSONA,
                   nuovi.NOME,
                   nuovi.NOME_PER_SEGNATURA,
                   nuovi.PARTITA_IVA,
                   nuovi.PARTITA_IVA_IMPRESA,
                   nuovi.PI,
                   nuovi.PI_BENEFICIARIO,
                   nuovi.PROVINCIA_BENEFICIARIO,
                   nuovi.PROVINCIA_DOM,
                   nuovi.PROVINCIA_PER_SEGNATURA,
                   nuovi.PROVINCIA_RES,
                   nuovi.SESSO,
                   nuovi.SIGLA_PROV_AMM,
                   nuovi.SIGLA_PROV_AOO,
                   nuovi.SIGLA_PROV_UO,
                   nuovi.TEL_DOM,
                   nuovi.TEL_RES,
                   nuovi.TEL_UO,
                   nuovi.TIPO,
                   nuovi.TIPO_LOCALIZZAZIONE,
                   nuovi.TIPO_SOGGETTO,
                   nuovi.VIA_IMPRESA,
                   nuovi.VIS_INDIRIZZO);

      IF conta = 100
      THEN
         COMMIT;
         conta := 0;
      END IF;
   END LOOP;

   conta := 0;

   FOR vecchi
      IN (SELECT COD_AMM,
                 COD_AMM_ORIGINALE,
                 COD_AOO,
                 COD_AOO_ORIGINALE,
                 COD_UO,
                 COD_UO_ORIGINALE,
                 EMAIL
            FROM SEG_AMM_AOO_UO_TAB
          MINUS
          SELECT COD_AMM,
                 COD_AMM_ORIGINALE,
                 COD_AOO,
                 COD_AOO_ORIGINALE,
                 COD_UO,
                 COD_UO_ORIGINALE,
                 EMAIL
            FROM SEG_AMM_AOO_UO)
   LOOP
      conta := conta + 1;

      DELETE SEG_AMM_AOO_UO_TAB
       WHERE     cod_amm = vecchi.cod_amm
             AND NVL (cod_aoo, ' ') = NVL (vecchi.cod_aoo, ' ')
             AND NVL (cod_uo, ' ') = NVL (vecchi.cod_uo, ' ')
             AND NVL (email, ' ') = NVL (vecchi.email, ' ');

      IF conta = 100
      THEN
         COMMIT;
         conta := 0;
      END IF;
   END LOOP;

   COMMIT;
EXCEPTION
   WHEN OTHERS
   THEN
      ROLLBACK;
END;
/
